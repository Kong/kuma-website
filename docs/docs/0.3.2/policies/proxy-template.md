# Proxy Template

When out-of-the-box `Kuma` capabilities are not enough,
you can use `ProxyTemplate` policy to configure [low-level Envoy resources](https://www.envoyproxy.io/docs/envoy/latest/api-v2/api) directly.

Technically, it means that you can provide definitions of
[Listeners](https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/listener.proto#listener),
[Clusters](https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/cluster.proto#cluster),
[ClusterLoadAssignments](https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/endpoint.proto#clusterloadassignment)
and [RouteConfigurations](https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/route.proto#routeconfiguration)
that will either complement or override those resources that `Kuma` generates automatically.

Internally, `Kuma` assumes that configuration of every dataplane is defined through a `ProxyTemplate`.

If you don't specify one manually, the implicit default template will be used, i.e.

```yaml
type: ProxyTemplate
mesh: <any>
name: <implicit default template>

# `selectors` define a subset of `Dataplanes` this `ProxyTemplate` should apply to
selectors:
  # selector matches tags either on an `inbound` or on a `gateway` interface
  - match:
      service: '*'

# `conf` defines the desired dataplane configuration
conf:
  # `imports` let you reuse dataplane configuration that Kuma can generate automatically and add a few tweaks on top of it
  imports:
    # `default-proxy` is a reference name for the default dataplane configuration generated by Kuma
    - default-proxy
```

In order to customize configuartion of a particular [Dataplane](../../documentation/dps-and-data-model/#dataplane-specification) (or a group of [Dataplanes](../../documentation/dps-and-data-model/#dataplane-specification)), you will need to provide a custom `ProxyTemplate` with proper `selectors` and `conf`, e.g.`

```yaml
type: ProxyTemplate
mesh: default
name: my-custom-template

# `selectors` define a subset of Dataplanes this ProxyTemplate should apply to
selectors:
  # selector matches tags either on an `inbound` or on a `gateway` interface
  - match:
      service: backend
      env:     prod

# `conf` defines the desired dataplane configuration
conf:
  # `imports` let you reuse dataplane configuration that Kuma can generate automatically and add a few tweaks on top of it
  imports:
    # `default-proxy` is a reference name for the default dataplane configuration generated by Kuma
    - default-proxy

  # `resources` define a list of raw Envoy resources that will either complement or override auto-generated ones
  resources:
    - name: localhost:9901
      version: v1
      # `resource` is a raw Envoy resource, either in YAML or JSON format
      resource: |
        '@type': type.googleapis.com/envoy.api.v2.Cluster
        connectTimeout: 5s
        name: localhost:9901
        ...
```

Notice that:

1. `selectors` allow you to limit the scope of [Dataplanes](../../documentation/dps-and-data-model/#dataplane-specification) this `ProxyTemplate` should apply to
2. `imports` allow you to reuse configuration that Kuma can generate automatically and add a few tweaks on top of it
3. `resources` allow you to provide raw Envoy resources that will either complement or override auto-generated ones

::: tip
In the current release, the only available canned configuration that can be used inside `imports` section is called `default-proxy`.

In future releases, more of these will be available and it will also be possible for a user to define them to re-use across their infrastructure.
:::

At runtime, whenever `Kuma Control Plane` needs to generate configuration for a given [Dataplane](../../documentation/dps-and-data-model/#dataplane-specification), it will behave as follows:
* First, it will search for all `ProxyTemplates` that have been defined in the [Mesh](../mesh/) a given [Dataplane](../../documentation/dps-and-data-model/#dataplane-specification)belongs to
* Next, it will select only those `ProxyTemplates` whose `selectors` match either an `inbound` or a `gateway` interface of a given [Dataplane](../../documentation/dps-and-data-model/#dataplane-specification)
* Next, every matching `ProxyTemplate` will be [ranked](../how-kuma-chooses-the-right-policy-to-apply/)
* Then, `ProxyTemplate` with the highest rank will be used to generate configuration for a dataplane (Envoy)
* If a `ProxyTemplate` defines `imports`, their resources will be generated first
* If a `ProxyTemplate` defines `resources`, they will be copied "as is" and override auto-generated resources with the same names

On Universal:

```yaml
type: ProxyTemplate
mesh: default
name: template-1
selectors:
  - match:
      service: backend
conf:
  imports:
    - default-proxy
  resources:
    - ..
    - ..
```

On Kubernetes:

```yaml
apiVersion: kuma.io/v1alpha1
kind: ProxyTemplate
mesh: default
metadata:
  namespace: default
  name: template-1
spec:
  selectors:
    - match:
        service: backend
  conf:
    imports:
      - default-proxy
    resources:
      - ..
      - ..
```

As a practical example, the following `ProxyTemplate` will configure matching dataplanes (Envoys) to proxy requests to internal Envoy Admin API:

```yaml
type: ProxyTemplate
mesh: default
name: template-1
selectors:
  - match:
      service: backend
conf:
  imports:
    - default-proxy
  resources:
    - name: localhost:9901
      version: v1
      resource: |
        '@type': type.googleapis.com/envoy.api.v2.Cluster
        connectTimeout: 5s
        name: localhost:9901
        loadAssignment:
          clusterName: localhost:9901
          endpoints:
          - lbEndpoints:
            - endpoint:
                address:
                  socketAddress:
                    address: 127.0.0.1
                    portValue: 9901    # port on which Envoy Admin API is running is configurable via `--admin-port` option of `kuma-dp`
        type: STATIC
    - name: inbound:0.0.0.0:4040
      version: v1
      resource: |
        '@type': type.googleapis.com/envoy.api.v2.Listener
        name: inbound:0.0.0.0:4040
        address:
          socket_address:
            address: 0.0.0.0
            port_value: 4040
        filter_chains:
        - filters:
          - name: envoy.http_connection_manager
            config:
              route_config:
                virtual_hosts:
                - routes:
                  - match:
                      prefix: /stats
                    route:
                      cluster: localhost:9901
                  domains:
                  - '*'
                  name: envoy_admin
              codec_type: AUTO
              http_filters:
                name: envoy.router
              stat_prefix: envoy_stats
```
