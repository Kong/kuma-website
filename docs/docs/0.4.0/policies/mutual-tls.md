# Mutual TLS

This policy enables automatic encrypted mTLS traffic for all the services in a [`Mesh`](../mesh).

Kuma ships with a `builtin` CA (Certificate Authority) which is initialized with an auto-generated root certificate. The root certificate is unique for every [`Mesh`](../mesh) and it used to sign identity certificates for every data-plane. Kuma also supports third-party CA.

The mTLS feature is used for AuthN/Z as well: each data-plane is being assigned with a workload identity certificate, which is SPIFFE compatible. This certificate has a SAN set to `spiffe://<mesh name>/<service name>`. When Kuma enforces policies that require an identity, like [`TrafficPermission`](../traffic-permissions), it will extract the SAN from the client certificate and use it for every identity matching operation.

By default, mTLS is **not** enabled. You can enable Mutual TLS by updating the [`Mesh`](../mesh) policy with the `mtls` setting.

::: tip
With mTLS enabled, all traffic is denied by default.

Remember to apply a `TrafficPermission` policy to explictly allow legitimate traffic between certain Dataplanes.
:::

## Builtin CA

On Universal:

```yaml
type: Mesh
name: default
mtls:
  enabledBackend: ca-1 # enable mTLS 
  backends:
  - name: ca-1
    type: builtin # use Builtin CA (a unique Root CA certificate will be generated automatically)
```

You can apply this configuration with `kumactl apply -f [file-path]`.

On Kubernetes:

```yaml
apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: default
spec:
  mtls:
    enabledBackend: ca-1 # enable mTLS 
    backends:
    - name: ca-1
      type: builtin # use Builtin CA (a unique Root CA certificate will be generated automatically)
```

You can apply this configuration with `kubectl apply -f [file-path]`.

### Access builtin CA

You can access the autogenerated certificates using [Secret Management](../documentation/secret-management.md). Builtin CA is stored with following pattern for Secrets name:
```
Key  => $MESH_NAME.ca-builtin-key-$NAME_OF_CA
Cert => $MESH_NAME.ca-builtin-cert-$NAME_OF_CA
```

Example for Mesh: default and CA name of ca-1

Universal:
```sh
$ kumactl get secrets
MESH      NAME
default   default.ca-builtin-cert-ca-1
default   default.ca-builtin-key-ca-1
```

Kubernetes:
```sh
$ kubectl get secrets -n kuma-system --field-selector='type=system.kuma.io/secret'
NAME                           TYPE                    DATA   AGE
default.ca-builtin-cert-ca-1   system.kuma.io/secret   1      3m12s
default.ca-builtin-key-ca-1    system.kuma.io/secret   1      3m12s
```


## Provided CA

In some cases users might need to opt out of auto-generated Root CA certificates, e.g. to stay compliant with internal company policies.

To that end, Kuma supports another type of CA - `provided` CA.

Like the name implies, a user will have to provide a custom Root CA certificate and take a responsibility for managing its lifecycle.

To use Provided CA complete following steps

### Universal

1. Provide key and certificate using [Secret Management](../documentation/secret-management.md)

```sh
$ cat secret-ca-cert.yaml
type: Secret
mesh: default
name: ca-cert
data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURFekNDQWZ1Z0F... # cert in Base64

$ kumactl apply -f secret-ca-cert.yaml

$ cat secret-ca-key.yaml
type: Secret
mesh: default
name: ca-key
data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQk... # key in Base64

$ kumactl apply -f secret-ca-key.yaml

$ kumactl get secrets
MESH      NAME
default   ca-cert
default   ca-key
```

2. Enable Provided CA on Mesh

```shell
echo "
type: Mesh
name: default
mtls:
enabledBackend: ca-1
backends:
- name: ca-1
  type: provided
  config:
    cert:
      secret: ca-cert
    key:
      secret: ca-key
" | kumactl apply -f -
```

### Kubernetes

1. Provide key and certificate using [Secret Management](../documentation/secret-management.md)

```sh
$ cat secret-ca-cert.yaml
apiVersion: v1
kind: Secret
metadata:
  labels:
    kuma.io/mesh: default
  name: ca-cert
  namespace: kuma-system
data:
  value: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURHekNDQWdPZ0F3S... # cert in Base64
type: system.kuma.io/secret

$ kubectl apply -f secret-ca-cert.yaml

$ cat secret-ca-key.yaml
apiVersion: v1
kind: Secret
metadata:
  labels:
    kuma.io/mesh: default
  name: ca-key
  namespace: kuma-system
data:
  value: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS... # key in Base64
type: system.kuma.io/secret

$ kubectl apply -f secret-ca-key.yaml
```

2. Enable Provided CA on Mesh

```sh
echo "
apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: default
spec:
  mtls:
    backends:
    - name: ca-1
      type: provided
      config:
        cert:
          secret: ca-cert
        key:
          secret: ca-key
" | kumactl apply -f -
```

::: warning
Root CA certificate provided by a user must meet certain constraints:
1. It MUST be a self-signed Root CA certificate (Intermediate CA certificates are not allowed)
2. It MUST have basic constraint `CA` set to `true` (see [X509-SVID: 4.1. Basic Constraints](https://github.com/spiffe/spiffe/blob/master/standards/X509-SVID.md#41-basic-constraints))
3. It MUST have key usage extension `keyCertSign` set (see [X509-SVID: 4.3. Key Usage](https://github.com/spiffe/spiffe/blob/master/standards/X509-SVID.md#43-key-usage))
4. It MUST NOT have key usage extension 'digitalSignature' set (see [X509-SVID: Appendix A. X.509 Field Reference](https://github.com/spiffe/spiffe/blob/master/standards/X509-SVID.md#appendix-a-x509-field-reference))
5. It MUST NOT have key usage extension 'keyAgreement' set (see [X509-SVID: Appendix A. X.509 Field Reference](https://github.com/spiffe/spiffe/blob/master/standards/X509-SVID.md#appendix-a-x509-field-reference))
6. It MUST NOT have key usage extension 'keyEncipherment' set (see [X509-SVID: Appendix A. X.509 Field Reference](https://github.com/spiffe/spiffe/blob/master/standards/X509-SVID.md#appendix-a-x509-field-reference))

If a provided certificate doesn't meet those constraints, applying Mesh with enabled Provided CA will fail.
:::

### Other ways of providing CA

Depending on your use case you may want to provide CA in a file or just in the configuration (during testing). You can do this in the following way

#### Universal

```yaml
type: Mesh
name: default
mtls:
enabledBackend: ca-1
backends:
- name: ca-1
  type: provided
  config:
    cert:
      inline: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURHekNDQWdPZ0F3S... # cert in Base64
    key:
      file: /opt/cert.key
```

#### Kubernetes

```yaml
apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: default
spec:
  mtls:
    backends:
    - name: ca-1
      type: provided
      config:
        cert:
          inline: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURHekNDQWdPZ0F3S... # cert in Base64
        key:
          file: /opt/cert.key
```

If you decide to use Provided CA from file make sure it is consistent across all the instances of the Control Plane.

### CA change

To change CA from one to another, you have to first disable mTLS (by removing `enabledBackend` property) and then re-enable it with other CA. In the future Kuma will support CA rotation.
